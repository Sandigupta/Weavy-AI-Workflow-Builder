{
  "version": 3,
  "sources": ["../../../src/trigger/media-tasks.ts"],
  "sourcesContent": ["import { task, logger } from \"@trigger.dev/sdk/v3\";\r\nimport { readFileSync } from \"fs\";\r\nimport { join } from \"path\";\r\n\r\n// Manual env loading for Trigger.dev dev mode\r\n// Trigger.dev v3 should auto-load .env but seems to have issues\r\ntry {\r\n    const envPath = join(process.cwd(), '.env');\r\n    const envContent = readFileSync(envPath, 'utf-8');\r\n    envContent.split('\\n').forEach(line => {\r\n        const match = line.match(/^([^=:#]+)=(.*)$/);\r\n        if (match && !process.env[match[1]]) {\r\n            process.env[match[1]] = match[2].trim();\r\n        }\r\n    });\r\n} catch (error) {\r\n    logger.warn('Could not load .env file manually', { error });\r\n}\r\n\r\nasync function runTransloadit(steps: any, ctx: any) {\r\n    const key = process.env.TRANSLOADIT_KEY;\r\n    const secret = process.env.TRANSLOADIT_SECRET;\r\n\r\n    logger.log(\"Transloadit env check:\", {\r\n        hasKey: !!key,\r\n        hasSecret: !!secret,\r\n        keyPreview: key ? `${key.substring(0, 8)}...` : 'missing'\r\n    });\r\n\r\n    if (!key || !secret) {\r\n        throw new Error(\"Missing TRANSLOADIT_KEY or TRANSLOADIT_SECRET\");\r\n    }\r\n\r\n    // Dynamic import to avoid build crashes if package is missing\r\n    const transloaditModule = await import(\"transloadit\") as any;\r\n    const Transloadit = transloaditModule.default || transloaditModule;\r\n\r\n    // DEBUG: Log the type of Transloadit to verify it's a constructor\r\n    if (typeof Transloadit !== 'function') {\r\n        console.error('[cropImage] Transloadit import failed. Imported:', transloaditModule);\r\n        throw new Error(`Transloadit is not a constructor. It is a ${typeof Transloadit}`);\r\n    }\r\n\r\n    const client = new Transloadit({\r\n        authKey: key,\r\n        authSecret: secret,\r\n    });\r\n\r\n    logger.log(\"Creates Transloadit Assembly\", { steps });\r\n\r\n    const assembly = await client.createAssembly({\r\n        params: {\r\n            steps,\r\n            // We want to wait for the result\r\n            template_id: undefined, // ensure no template is enforced\r\n        },\r\n        waitForCompletion: true, // SDK feature to poll\r\n    });\r\n\r\n    if (assembly.error) {\r\n        throw new Error(`Transloadit Error: ${assembly.error}`);\r\n    }\r\n\r\n    // Find the result from the last step\r\n    const resultKeys = Object.keys(assembly.results);\r\n    const lastStep = resultKeys[resultKeys.length - 1]; // Naive last step\r\n    const results = assembly.results[lastStep];\r\n\r\n    if (!results || results.length === 0) {\r\n        throw new Error(\"No output generated from Transloadit\");\r\n    }\r\n\r\n    return results[0].ssl_url;\r\n}\r\n\r\nexport const cropImage = task({\r\n    id: \"crop-image\",\r\n    run: async (payload: { imageUrl: string; width: number; height: number; x: number; y: number }, { ctx }) => {\r\n        logger.log(\"Cropping Image (Transloadit)\", payload);\r\n\r\n        // Define Transloadit Steps\r\n        const steps = {\r\n            imported_image: {\r\n                robot: \"/http/import\",\r\n                url: payload.imageUrl,\r\n            },\r\n            cropped: {\r\n                use: \"imported_image\",\r\n                robot: \"/image/resize\",\r\n                width: payload.width,\r\n                height: payload.height,\r\n                resize_strategy: \"crop\", // crops to fill dimensions\r\n                // Note: Specific x/y offsets requires /image/crop robot or specific crop strategy configs\r\n                // For now, we use standard center crop which is \"resize_strategy: crop\"\r\n            }\r\n        };\r\n\r\n        try {\r\n            const outputUrl = await runTransloadit(steps, ctx);\r\n            return {\r\n                outputUrl,\r\n                message: \"Image cropped successfully via Transloadit\"\r\n            };\r\n        } catch (error: any) {\r\n            // Fallback for demo/dev if keys missing or SDK missing\r\n            if (error.code === 'MODULE_NOT_FOUND' || error.message.includes(\"Transloadit\")) {\r\n                logger.warn(\"Transloadit failed, falling back to mock\", { error });\r\n                return {\r\n                    // Use a more reliable placeholder service\r\n                    outputUrl: `https://placehold.co/${payload.width}x${payload.height}/orange/white?text=Mock+Crop`,\r\n                    message: \"Mocked: Transloadit dependency or keys missing\"\r\n                };\r\n            }\r\n            throw error;\r\n        }\r\n    },\r\n});\r\n\r\nexport const extractFrame = task({\r\n    id: \"extract-frame\",\r\n    run: async (payload: { videoUrl: string; timestamp: number }, { ctx }) => {\r\n        logger.log(\"Extracting Frame (Transloadit)\", payload);\r\n\r\n        const steps = {\r\n            imported_video: {\r\n                robot: \"/http/import\",\r\n                url: payload.videoUrl,\r\n            },\r\n            extracted_thumb: {\r\n                use: \"imported_video\",\r\n                robot: \"/video/thumbs\",\r\n                count: 1,\r\n                // '00:00:05' format needed? or seconds? \r\n                // Transloadit /video/thumbs uses 'offsets' in seconds or time strings.\r\n                ffmpeg_stack: \"v4.3.1\",\r\n                offsets: [payload.timestamp || 0]\r\n            }\r\n        };\r\n\r\n        try {\r\n            const outputUrl = await runTransloadit(steps, ctx);\r\n            return {\r\n                outputUrl,\r\n                message: \"Frame extracted successfully via Transloadit\"\r\n            };\r\n        } catch (error: any) {\r\n            if (error.code === 'MODULE_NOT_FOUND' || error.message.includes(\"Transloadit\")) {\r\n                logger.warn(\"Transloadit failed, falling back to mock\");\r\n                return {\r\n                    outputUrl: \"https://via.placeholder.com/640x360.png?text=Frame+Extracted\",\r\n                    message: \"Mocked: Transloadit dependency or keys missing\"\r\n                };\r\n            }\r\n            throw error;\r\n        }\r\n    }\r\n});\r\n"],
  "mappings": "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",
  "names": []
}
